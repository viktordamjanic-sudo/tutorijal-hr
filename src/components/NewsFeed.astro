---
// NewsFeed Component â€” Stvarne vijesti kao prompt vjeÅ¾be
// Server-side rendered, no client JS needed
import Database from 'better-sqlite3';
import path from 'path';

interface Headline {
  id: number;
  title: string;
  description: string;
  published_at: string;
  scraped_at: string;
  url: string;
}

let headlines: Headline[] = [];

try {
  const dbPath = path.resolve(process.cwd(), 'scraper', 'headlines.db');
  const db = new Database(dbPath, { readonly: true });
  headlines = db.prepare(`
    SELECT id, title, description, published_at, scraped_at, url
    FROM headlines
    WHERE portal = 'jutarnji' AND description IS NOT NULL AND description != ''
    ORDER BY scraped_at DESC
    LIMIT 6
  `).all() as Headline[];
  db.close();
} catch (e) {
  console.error('NewsFeed: Could not read scraper DB:', e);
}

function getCategoryIcon(title: string, desc: string): string {
  const text = (title + ' ' + (desc || '')).toLowerCase();
  if (text.includes('zagreb')) return 'ğŸ™ï¸';
  if (text.includes('sabor') || text.includes('vlad') || text.includes('ministar')) return 'ğŸ‡­ğŸ‡·';
  if (text.includes('euro') || text.includes('cijena') || text.includes('novac') || text.includes('plaÄ‡a')) return 'ğŸ’°';
  if (text.includes('sport') || text.includes('nogomet') || text.includes('liga')) return 'âš½';
  if (text.includes('trump') || text.includes('eu ') || text.includes('europa')) return 'ğŸŒ';
  if (text.includes('Å¡kola') || text.includes('uÄenik') || text.includes('fakultet')) return 'ğŸ“';
  return 'ğŸ“°';
}

function timeAgo(dateStr: string): string {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const now = new Date();
  const hours = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60));
  if (hours < 1) return 'Upravo';
  if (hours < 24) return `Prije ${hours}h`;
  const days = Math.floor(hours / 24);
  return `Prije ${days}d`;
}

function truncate(text: string, len: number): string {
  if (!text) return '';
  return text.length > len ? text.slice(0, len) + '...' : text;
}
---

{headlines.length > 0 ? (
  <div class="t-grid t-grid--3">
    {headlines.map((h) => {
      const icon = getCategoryIcon(h.title, h.description);
      const time = timeAgo(h.published_at || h.scraped_at);
      return (
        <a href={`/modul/vijest-${h.id}`} class="t-card">
          <div class="t-card__top">
            <span class="t-card__icon">{icon}</span>
            <div class="t-card__badges">
              <span class="news-source-tag">Jutarnji</span>
            </div>
          </div>
          <h3 class="t-card__title">{truncate(h.title, 80)}</h3>
          <p class="t-card__desc">{truncate(h.description, 120)}</p>
          <div class="t-card__footer">
            <span class="news-time">{time}</span>
            <span class="t-card__arrow">VjeÅ¾baj â†’</span>
          </div>
        </a>
      );
    })}
  </div>
) : (
  <div class="news-empty">
    ğŸ“­ Nema novih vijesti. Pokrenite scraper (<code>python scraper/main.py</code>) za osvjeÅ¾avanje.
  </div>
)}

<style>
  .news-source-tag {
    font-size: 10px; font-weight: 700;
    padding: 2px 8px; border-radius: var(--radius-pill);
    background: #fff7ed; color: #c2410c;
    border: 1px solid rgba(194, 65, 12, 0.15);
    text-transform: uppercase; letter-spacing: 0.04em;
  }
  .news-time {
    font-size: 10px; color: var(--color-text-muted); font-weight: 500;
  }
  .news-empty {
    text-align: center; padding: 32px 0;
    color: var(--color-text-muted);
    font-size: var(--font-size-base); font-weight: 500;
  }
  .news-empty code {
    background: var(--color-surface-alt);
    padding: 2px 6px; border-radius: 4px;
    font-size: 12px;
  }
</style>
