---
// Module Detail Page ‚Äî Prompt-centered workspace
// Supports both PREDEFINED_TASKS and Convex-generated tasks
import Layout from '../../layouts/Layout.astro';
import { PREDEFINED_TASKS } from '../../lib/constants';
import { SignedIn, SignedOut } from '@clerk/astro/components';
import ConvexWorkspace from '../../components/workspace/ConvexWorkspace.tsx';

const { id } = Astro.params;
const task = PREDEFINED_TASKS.find(t => t.id === id);
const isConvexTask = !task;
// Convex tasks will be loaded client-side by ConvexWorkspace component
---

<Layout title={`${task?.title || 'Zadatak'} | tutorijal.hr`} hideSidebar={true}>
  <div class="workspace" id="workspace-root">

    {isConvexTask ? (
      <!-- Convex task: loaded client-side -->
      <SignedIn>
        <ConvexWorkspace taskId={id!} client:only="react" />
      </SignedIn>
      <SignedOut>
        <div class="locked-state">
          <div class="locked-card">
            <div class="locked-icon">üîí</div>
            <h3>Pristup zakljuƒçan</h3>
            <p>Prijavi se za testiranje AI modela u radnom prostoru.</p>
            <div class="locked-actions">
              <a href="/sign-up" class="btn-lock-primary">Kreiraj raƒçun</a>
              <a href="/sign-in" class="btn-lock-secondary">Prijava</a>
            </div>
          </div>
        </div>
      </SignedOut>
    ) : (
    <SignedIn>
      <!-- HERO-STYLE TOP SECTION -->
      <div class="ws-hero">
        <a href="/" class="ws-back">‚Üê Natrag na poƒçetnu</a>
        
        <div class="ws-hero-card">
          <!-- Left: Task info -->
          <div class="ws-hero-left">
            <div class="ws-badge">
              <span class="ws-badge-dot"></span>
              {task.category === 'parking' ? 'Komunikacija' : task.category === 'cooking' ? 'Svakodnevica' : task.category === 'language' ? 'Jezik' : task.category === 'finance' ? 'Financije' : 'Modul'}
              <span class="ws-diff-pill">{task.difficulty === 'beginner' ? '‚óè Poƒçetnik' : task.difficulty === 'intermediate' ? '‚óè‚óè Srednji' : '‚óè‚óè‚óè Napredni'}</span>
            </div>
            
            <h1 class="ws-hero-title">
              <span class="ws-hero-icon">{task.icon}</span>
              {task.title.replace(task.icon, '').trim()}
            </h1>

            <!-- Kontekst = Priƒça -->
            <div class="ws-story">
              <p class="ws-story-text">{task.scenario}</p>
            </div>

            <!-- Cilj = Call to action -->
            <div class="ws-goal">
              <span class="ws-goal-icon">üéØ</span>
              <div>
                <div class="ws-goal-label">Tvoj zadatak</div>
                <p class="ws-goal-text">{task.problem}</p>
              </div>
            </div>
          </div>

          <!-- Right: Prompt preview (terminal-style) -->
          <div class="ws-hero-right">
            <div class="ws-prompt-preview">
              <div class="ws-preview-dots">
                <span class="pvdot pvdot-red"></span>
                <span class="pvdot pvdot-yellow"></span>
                <span class="pvdot pvdot-green"></span>
                <span class="ws-preview-title">primjer prompta</span>
              </div>
              <div class="ws-preview-body">
                <div class="ws-preview-line">
                  <span class="ws-pv-tag">prompt</span>
                  <span class="ws-pv-text">{task.aiPrompt.length > 120 ? task.aiPrompt.slice(0, 120) + '...' : task.aiPrompt}</span>
                </div>
                <div class="ws-preview-line ws-pv-ai">
                  <span class="ws-pv-tag ws-pv-tag-ai">AI</span>
                  <span class="ws-pv-text">Analiziram tvoj prompt...</span>
                </div>
                <div class="ws-preview-line ws-pv-result">
                  <span class="ws-pv-tag ws-pv-tag-ok">‚≠ê‚≠ê‚≠ê</span>
                  <span class="ws-pv-text">Odliƒçan prompt!</span>
                </div>
              </div>
              <button
                class="ws-use-prompt-btn"
                onclick={`document.getElementById('ai-prompt').value = \`${task.aiPrompt.replace(/`/g, '\\`')}\`; document.getElementById('ai-prompt').focus(); document.getElementById('ai-prompt').dispatchEvent(new Event('input')); document.getElementById('chat-wrapper').scrollIntoView({behavior:'smooth'});`}
              >
                ‚ú® Koristi ovaj prompt
              </button>
            </div>

            <!-- Learning point floating chip -->
            <div class="ws-tip-chip">
              <span class="ws-tip-icon">üí°</span>
              <span class="ws-tip-text">{task.learningPoint}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- CHAT AREA -->
      <div class="ws-scroll" id="chat-wrapper">
        <div class="ws-content" id="chat-container">
          <!-- AI greeting -->
          <div class="msg-row msg-ai">
            <div class="msg-avatar ai-avatar">AI</div>
            <div class="msg-bubble ai-bubble">
              Bok! üëã Proƒçitaj zadatak gore i probaj napisati svoj prompt. Ocijenit ƒáu ga s ‚≠ê i pomoƒái ti da ga pobolj≈°a≈°. Kad bude≈° spreman/na, napi≈°i svoju uputu ispod!
            </div>
          </div>

        </div>
      </div>

      <!-- PROMPT INPUT ‚Äî fixed at bottom, centered, prominent -->
      <div class="ws-input-area">
        <div class="ws-composer">
          <!-- Quick suggestion -->
          <div class="composer-suggestions">
            <button
              class="suggest-chip"
              onclick={`document.getElementById('ai-prompt').value = \`${task.aiPrompt.replace(/`/g, '\\`')}\`; document.getElementById('ai-prompt').focus(); document.getElementById('ai-prompt').dispatchEvent(new Event('input'));`}
            >
              ‚ú® Koristi prijedlog
            </button>
          </div>
          <!-- Input row -->
          <div class="composer-row">
            <textarea
              id="ai-prompt"
              class="composer-input"
              rows={1}
              placeholder="Upi≈°i svoj prompt ovdje..."
              oninput="this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 140) + 'px'"
              onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); document.getElementById('send-to-ai').click(); }"
            ></textarea>
            <button
              id="send-to-ai"
              class="send-btn"
              data-task-id={task.id}
              data-task-title={task.title}
              data-task-scenario={task.scenario}
              data-task-problem={task.problem}
              onclick="window.sendToAI && window.sendToAI(this)"
              title="Po≈°alji (Enter)"
            >
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
              </svg>
            </button>
          </div>
          <p class="composer-hint">Enter za slanje ¬∑ Shift+Enter za novi red</p>
          <p id="rate-limit-notice" class="hidden rate-limit-msg">
            Prekoraƒçen limit zahtjeva. Priƒçekajte trenutak.
          </p>
        </div>
      </div>
    </SignedIn>

    <SignedOut>
      <div class="locked-state">
        <div class="locked-card">
          <div class="locked-icon">üîí</div>
          <h3>Pristup zakljuƒçan</h3>
          <p>Prijavi se za testiranje AI modela u radnom prostoru.</p>
          <div class="locked-actions">
            <a href="/sign-up" class="btn-lock-primary">Kreiraj raƒçun</a>
            <a href="/sign-in" class="btn-lock-secondary">Prijava</a>
          </div>
        </div>
      </div>
    </SignedOut>
    )}

  </div>

  <!-- Learning point data -->
  {task && <div id="learning-point-data" class="hidden" data-content={task.learningPoint}></div>}
</Layout>

<style>
  .workspace {
    display: flex; flex-direction: column;
    height: 100vh; overflow: hidden;
    background: #f5f5f0;
  }

  /* ===== HERO SECTION ===== */
  .ws-hero {
    background: linear-gradient(135deg, #fafaf7 0%, #eef2ff 50%, #f7f5ff 100%);
    padding: 20px 24px 0;
    flex-shrink: 0;
    border-bottom: 1px solid #e8e8e4;
  }
  .ws-back {
    font-size: 13px; color: #9ca3af; text-decoration: none; font-weight: 600;
    transition: color .15s; display: inline-block; margin-bottom: 16px;
  }
  .ws-back:hover { color: #4f6ef7; }

  .ws-hero-card {
    display: grid; grid-template-columns: 1fr 1fr; gap: 28px;
    align-items: start; padding-bottom: 24px;
  }

  .ws-badge {
    display: inline-flex; align-items: center; gap: 7px;
    background: rgba(79,110,247,.08); color: #4f6ef7;
    font-size: 11px; font-weight: 700; letter-spacing: .05em; text-transform: uppercase;
    padding: 5px 12px; border-radius: 99px; border: 1px solid rgba(79,110,247,.15); margin-bottom: 12px;
  }
  .ws-badge-dot { width: 6px; height: 6px; border-radius: 50%; background: #4f6ef7; animation: livepulse 2s infinite; }
  @keyframes livepulse { 0%,100%{opacity:1} 50%{opacity:.4} }
  .ws-diff-pill {
    background: rgba(79,110,247,.12); padding: 2px 8px; border-radius: 99px;
    font-size: 9px; letter-spacing: .03em;
  }

  .ws-hero-title {
    font-size: clamp(20px, 2.5vw, 28px); font-weight: 800; color: #1e1e1e;
    line-height: 1.25; margin-bottom: 14px; letter-spacing: -.02em;
    display: flex; align-items: center; gap: 10px;
  }
  .ws-hero-icon { font-size: 32px; flex-shrink: 0; }

  .ws-story {
    background: #fff; border: 1px solid #e8e8e4; border-radius: 12px;
    padding: 14px 18px; margin-bottom: 14px;
    box-shadow: 0 1px 4px rgba(0,0,0,.03);
  }
  .ws-story-text {
    font-size: 14px; color: #374151; font-weight: 500; line-height: 1.65;
  }

  .ws-goal {
    display: flex; align-items: flex-start; gap: 12px;
    background: linear-gradient(135deg, #eef2ff, #f0edff);
    border: 1.5px solid rgba(79,110,247,.2); border-radius: 12px;
    padding: 14px 18px;
  }
  .ws-goal-icon { font-size: 22px; flex-shrink: 0; margin-top: 1px; }
  .ws-goal-label {
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    letter-spacing: .08em; color: #4f6ef7; margin-bottom: 4px;
  }
  .ws-goal-text { font-size: 14px; color: #1e1e1e; font-weight: 600; line-height: 1.5; }

  /* Right side ‚Äî terminal preview */
  .ws-hero-right { position: relative; }
  .ws-prompt-preview {
    background: #fff; border-radius: 14px; padding: 0;
    border: 1px solid #e8e8e4;
    box-shadow: 0 4px 20px rgba(0,0,0,.06);
    overflow: hidden;
  }
  .ws-preview-dots {
    display: flex; align-items: center; gap: 6px; padding: 10px 16px;
    border-bottom: 1px solid #f0f0ec;
  }
  .pvdot { width: 8px; height: 8px; border-radius: 50%; }
  .pvdot-red { background: #fca5a5; }
  .pvdot-yellow { background: #fcd34d; }
  .pvdot-green { background: #86efac; }
  .ws-preview-title {
    font-size: 10px; font-weight: 600; color: #9ca3af;
    text-transform: uppercase; letter-spacing: .06em; margin-left: auto;
  }

  .ws-preview-body { padding: 14px 16px; display: flex; flex-direction: column; gap: 10px; }
  .ws-preview-line {
    display: flex; align-items: flex-start; gap: 8px;
    font-size: 12.5px; font-weight: 500; color: #374151; line-height: 1.5;
  }
  .ws-pv-tag {
    font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .05em;
    padding: 2px 8px; border-radius: 5px; flex-shrink: 0; margin-top: 2px;
    background: #eef2ff; color: #4f6ef7;
  }
  .ws-pv-tag-ai { background: #fef3c7; color: #d97706; }
  .ws-pv-tag-ok { background: #d1fae5; color: #059669; }
  .ws-pv-text { flex: 1; }
  .ws-pv-ai { color: #9ca3af; }
  .ws-pv-result { color: #059669; font-weight: 600; }

  .ws-use-prompt-btn {
    display: block; width: 100%; padding: 10px;
    background: linear-gradient(135deg, #f5f3ff, #eef2ff);
    border: none; border-top: 1px solid #e8e8e4;
    font-size: 13px; font-weight: 700; color: #7c3aed;
    cursor: pointer; transition: all .15s;
    font-family: 'Inter', sans-serif;
  }
  .ws-use-prompt-btn:hover { background: #ede9fe; }

  .ws-tip-chip {
    display: flex; align-items: flex-start; gap: 8px;
    background: #fff; border: 1px solid #e8e8e4; border-radius: 12px;
    padding: 12px 16px; margin-top: 14px;
    box-shadow: 0 1px 4px rgba(0,0,0,.04);
    animation: floattip 3s ease-in-out infinite;
  }
  .ws-tip-icon { font-size: 16px; flex-shrink: 0; }
  .ws-tip-text { font-size: 12.5px; color: #6b7280; font-weight: 500; line-height: 1.5; }
  @keyframes floattip { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

  @media (max-width: 768px) {
    .ws-hero-card { grid-template-columns: 1fr; }
    .ws-hero-right { display: none; }
    .ws-hero { padding: 16px 16px 0; }
  }

  /* ===== SCROLLABLE CHAT AREA ===== */
  .ws-scroll {
    flex: 1; overflow-y: auto; padding: 24px;
    min-height: 0;
  }
  .ws-content {
    max-width: 720px; margin: 0 auto;
    display: flex; flex-direction: column; gap: 20px;
  }
  .task-block-accent { background: #eef2ff; border-color: rgba(79,110,247,.2); }
  .task-block-hint { background: #f5f3ff; border-color: rgba(124,58,237,.15); }
  .task-block-label {
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    letter-spacing: .08em; color: #9ca3af; margin-bottom: 5px;
  }
  .task-block-text { font-size: 13.5px; color: #374151; line-height: 1.6; font-weight: 500; }

  /* ===== MESSAGES ===== */
  .msg-row { display: flex; gap: 10px; align-items: flex-start; }
  .msg-ai { flex-direction: row; }
  .msg-user { flex-direction: row-reverse; }

  .msg-avatar {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 800; flex-shrink: 0;
  }
  .ai-avatar { background: #eef2ff; color: #4f6ef7; }
  .user-avatar { background: #e5e7eb; color: #6b7280; }

  .msg-bubble {
    max-width: 80%; font-size: 14px; font-weight: 500;
    line-height: 1.65; padding: 12px 18px; border-radius: 16px;
  }
  .ai-bubble {
    background: #fff; color: #374151;
    border: 1px solid #e8e8e4;
    border-top-left-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,.04);
  }
  .user-bubble {
    background: linear-gradient(135deg, #4f6ef7, #5a78f8); color: #fff;
    border-top-right-radius: 4px;
  }

  /* ===== PROMPT INPUT AREA ‚Äî BIG, CENTERED ===== */
  .ws-input-area {
    background: #fff; border-top: 1px solid #e8e8e4;
    padding: 16px 24px 20px; flex-shrink: 0;
  }
  .ws-composer {
    max-width: 720px; margin: 0 auto;
  }
  .composer-suggestions { margin-bottom: 10px; text-align: center; }
  .suggest-chip {
    background: #f5f3ff; color: #7c3aed; border: 1px solid rgba(124,58,237,.15);
    border-radius: 99px; padding: 6px 16px;
    font-size: 12.5px; font-weight: 700; cursor: pointer;
    transition: all .15s;
    font-family: 'Inter', sans-serif;
  }
  .suggest-chip:hover { background: #ede9fe; transform: translateY(-1px); }

  .composer-row {
    display: flex; align-items: flex-end; gap: 12px;
    background: #fafaf8; border: 2px solid #e8e8e4;
    border-radius: 16px; padding: 12px 12px 12px 18px;
    transition: border-color .2s, box-shadow .2s;
  }
  .composer-row:focus-within {
    border-color: #4f6ef7;
    box-shadow: 0 0 0 4px rgba(79,110,247,.08);
  }
  .composer-input {
    flex: 1; background: transparent; border: none;
    outline: none; resize: none;
    font-size: 15px; font-weight: 500; color: #1e1e1e;
    line-height: 1.55; min-height: 26px; max-height: 140px;
    font-family: 'Inter', sans-serif;
  }
  .composer-input::placeholder { color: #b0b0a8; }
  .send-btn {
    width: 42px; height: 42px; border-radius: 12px;
    background: linear-gradient(135deg, #4f6ef7, #5a78f8); border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: #fff; flex-shrink: 0; transition: all .15s;
    box-shadow: 0 2px 8px rgba(79,110,247,.3);
  }
  .send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(79,110,247,.4); }
  .send-btn:disabled { opacity: .5; transform: none; cursor: not-allowed; }

  .composer-hint {
    text-align: center; font-size: 11px; color: #b0b0a8;
    margin-top: 8px; font-weight: 500;
  }

  .rate-limit-msg {
    margin-top: 8px; font-size: 12.5px; font-weight: 600;
    color: #ef4444; background: #fef2f2; padding: 8px 14px;
    border-radius: 8px; border: 1px solid #fecaca; text-align: center;
  }
  .hidden { display: none; }

  /* Locked state */
  .locked-state {
    flex: 1; display: flex; align-items: center;
    justify-content: center; padding: 40px 20px;
  }
  .locked-card {
    background: #fff; border: 1px solid #e8e8e4;
    border-radius: 18px; padding: 36px 40px;
    text-align: center; max-width: 340px;
    box-shadow: 0 4px 20px rgba(0,0,0,.05);
  }
  .locked-icon { font-size: 40px; margin-bottom: 14px; }
  .locked-card h3 { font-size: 18px; font-weight: 800; color: #1e1e1e; margin-bottom: 8px; }
  .locked-card p { font-size: 13.5px; color: #6b7280; font-weight: 500; line-height: 1.55; margin-bottom: 22px; }
  .locked-actions { display: flex; flex-direction: column; gap: 10px; }
  .btn-lock-primary {
    background: linear-gradient(135deg, #4f6ef7, #5a78f8); color: #fff;
    padding: 11px 20px; border-radius: 10px;
    font-size: 14px; font-weight: 700; text-decoration: none;
    text-align: center; transition: all .15s;
    box-shadow: 0 2px 8px rgba(79,110,247,.3);
  }
  .btn-lock-primary:hover { transform: translateY(-1px); }
  .btn-lock-secondary {
    background: #fff; color: #374151;
    border: 1.5px solid #e8e8e4;
    padding: 11px 20px; border-radius: 10px;
    font-size: 14px; font-weight: 700; text-decoration: none;
    text-align: center; transition: all .15s;
  }
  .btn-lock-secondary:hover { border-color: #4f6ef7; color: #4f6ef7; }

  /* Mobile */
  @media (max-width: 768px) {
    .ws-topbar, .cw-topbar { padding: 10px 16px; }
    .ws-scroll, .cw-scroll { padding: 16px; }
    .ws-input-area, .cw-input-area { padding: 12px 16px 16px; }
    .task-card, .cw-task-card { padding: 16px; }
  }

</style>

<!-- Global styles for React client:only components (Astro scoping can't reach them) -->
<style is:global>
  /* ===== CONVEX WORKSPACE (cw-*) ===== */
  .cw-loading { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 80px 20px; flex: 1; }
  .cw-loading span { color: #9ca3af; font-weight: 600; font-size: 14px; }
  .cw-spinner { width: 28px; height: 28px; border: 3px solid #e5e7eb; border-top-color: #4f6ef7; border-radius: 50%; animation: cwspin 1s linear infinite; }
  @keyframes cwspin { to { transform: rotate(360deg); } }

  .cw-error { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 60px 20px; text-align: center; }
  .cw-error-icon { font-size: 40px; }
  .cw-error h3 { font-size: 18px; font-weight: 800; color: #1e1e1e; }
  .cw-error p { font-size: 13.5px; color: #6b7280; font-weight: 500; }
  .cw-back-btn { margin-top: 8px; color: #4f6ef7; font-size: 14px; font-weight: 700; text-decoration: none; }
  .cw-back-btn:hover { text-decoration: underline; }

  .cw-topbar { display: flex; align-items: center; gap: 16px; padding: 12px 24px; background: #fff; border-bottom: 1px solid #e8e8e4; flex-shrink: 0; }
  .cw-back { font-size: 13px; color: #9ca3af; text-decoration: none; font-weight: 600; transition: color .15s; flex-shrink: 0; }
  .cw-back:hover { color: #4f6ef7; }
  .cw-title-row { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: center; }
  .cw-icon { font-size: 18px; }
  .cw-title { font-size: 14px; font-weight: 700; color: #1e1e1e; }
  .cw-status { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #10b981; font-weight: 600; flex-shrink: 0; }
  .cw-status-dot { width: 6px; height: 6px; background: #10b981; border-radius: 50%; animation: livepulse 2s infinite; }

  .cw-scroll { flex: 1; overflow-y: auto; padding: 24px; min-height: 0; }
  .cw-content { max-width: 720px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

  .cw-task-card { background: #fff; border-radius: 16px; padding: 20px 24px; border: 1px solid #e8e8e4; box-shadow: 0 1px 4px rgba(0,0,0,.03); }
  .cw-chips { display: flex; gap: 8px; margin-bottom: 14px; }
  .cw-chip { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; padding: 3px 10px; border-radius: 99px; background: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; }
  .cw-chip-diff { background: #eef2ff; color: #4f6ef7; border-color: rgba(79,110,247,.2); }

  .cw-block { background: #fafaf8; border: 1px solid #e8e8e4; border-radius: 10px; padding: 12px 16px; margin-top: 10px; }
  .cw-block-goal { background: #eef2ff; border-color: rgba(79,110,247,.2); }
  .cw-block-hint { background: #f5f3ff; border-color: rgba(124,58,237,.15); }
  .cw-block-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; color: #9ca3af; margin-bottom: 5px; }
  .cw-block-text { font-size: 13.5px; color: #374151; line-height: 1.6; font-weight: 500; }

  .cw-msg { display: flex; gap: 10px; align-items: flex-start; }
  .cw-msg-ai { flex-direction: row; }
  .cw-msg-user { flex-direction: row-reverse; }
  .cw-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; flex-shrink: 0; }
  .cw-avatar-ai { background: #eef2ff; color: #4f6ef7; }
  .cw-avatar-user { background: #e5e7eb; color: #6b7280; }
  .cw-bubble { max-width: 80%; font-size: 14px; font-weight: 500; line-height: 1.65; padding: 12px 18px; border-radius: 16px; }
  .cw-bubble-ai { background: #fff; color: #374151; border: 1px solid #e8e8e4; border-top-left-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,.04); }
  .cw-bubble-user { background: linear-gradient(135deg, #4f6ef7, #5a78f8); color: #fff; border-top-right-radius: 4px; }

  .cw-dot { animation: cwbounce .8s infinite; }
  .cw-dot-2 { animation-delay: .15s; }
  .cw-dot-3 { animation-delay: .3s; }
  @keyframes cwbounce { 0%,100%{ opacity:1 } 50%{ opacity:.3 } }

  .cw-input-area { background: #fff; border-top: 1px solid #e8e8e4; padding: 16px 24px 20px; flex-shrink: 0; }
  .cw-composer { max-width: 720px; margin: 0 auto; text-align: center; }
  .cw-suggest { background: #f5f3ff; color: #7c3aed; border: 1px solid rgba(124,58,237,.15); border-radius: 99px; padding: 6px 16px; font-size: 12.5px; font-weight: 700; cursor: pointer; transition: all .15s; font-family: 'Inter', sans-serif; margin-bottom: 10px; }
  .cw-suggest:hover { background: #ede9fe; transform: translateY(-1px); }
  .cw-input-row { display: flex; align-items: flex-end; gap: 12px; background: #fafaf8; border: 2px solid #e8e8e4; border-radius: 16px; padding: 12px 12px 12px 18px; transition: border-color .2s, box-shadow .2s; }
  .cw-input-row:focus-within { border-color: #4f6ef7; box-shadow: 0 0 0 4px rgba(79,110,247,.08); }
  .cw-input-row textarea { flex: 1; background: transparent; border: none; outline: none; resize: none; font-size: 15px; font-weight: 500; color: #1e1e1e; line-height: 1.55; min-height: 26px; max-height: 140px; font-family: 'Inter', sans-serif; }
  .cw-input-row textarea::placeholder { color: #b0b0a8; }
  .cw-send { width: 42px; height: 42px; border-radius: 12px; background: linear-gradient(135deg, #4f6ef7, #5a78f8); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #fff; flex-shrink: 0; transition: all .15s; box-shadow: 0 2px 8px rgba(79,110,247,.3); font-size: 18px; font-weight: 700; }
  .cw-send:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(79,110,247,.4); }
  .cw-send:disabled { opacity: .5; transform: none; cursor: not-allowed; }
  .cw-hint { text-align: center; font-size: 11px; color: #b0b0a8; margin-top: 8px; font-weight: 500; }
</style>

<script is:inline>
  window.sendToAI = async function(btn) {
    const promptTextarea = document.getElementById('ai-prompt');
    const chatContainer = document.getElementById('chat-container');
    const learningPointData = document.getElementById('learning-point-data');

    const prompt = promptTextarea.value.trim();
    if (!prompt) return;

    // 1. User bubble
    const userBubble = document.createElement('div');
    userBubble.className = 'msg-row msg-user';
    userBubble.innerHTML = `
      <div class="msg-bubble user-bubble" style="white-space:pre-wrap">${prompt.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
      <div class="msg-avatar user-avatar">Ja</div>
    `;
    chatContainer.appendChild(userBubble);
    userBubble.scrollIntoView({ behavior: 'smooth', block: 'end' });

    // Clear input
    promptTextarea.value = '';
    promptTextarea.style.height = '26px';
    btn.disabled = true;
    btn.innerHTML = `<span style="animation:spin 1s linear infinite;display:inline-block;">‚è≥</span>`;

    // 2. AI loading bubble
    const aiBubble = document.createElement('div');
    aiBubble.className = 'msg-row msg-ai';
    aiBubble.innerHTML = `
      <div class="msg-avatar ai-avatar">AI</div>
      <div class="msg-bubble ai-bubble" style="color:#9ca3af;display:flex;align-items:center;gap:4px;">
        Razmi≈°lja
        <span style="animation:bounce .8s infinite;">.</span>
        <span style="animation:bounce .8s .15s infinite;">.</span>
        <span style="animation:bounce .8s .3s infinite;">.</span>
      </div>
    `;
    chatContainer.appendChild(aiBubble);
    aiBubble.scrollIntoView({ behavior: 'smooth', block: 'end' });

    try {
      const response = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt,
          taskId: btn.dataset.taskId,
          context: 'Zadatak: ' + (btn.dataset.taskTitle || '') + '\nScenarij: ' + (btn.dataset.taskScenario || '') + '\nProblem: ' + (btn.dataset.taskProblem || '')
        })
      });

      if (response.status === 401) {
        chatContainer.removeChild(aiBubble);
        chatContainer.removeChild(userBubble);
        promptTextarea.value = prompt;
        return;
      }

      const data = await response.json();
      if (!response.ok || data.error) throw new Error(data.error || 'HTTP ' + response.status);

      aiBubble.innerHTML = `
        <div class="msg-avatar ai-avatar">AI</div>
        <div class="msg-bubble ai-bubble" style="white-space:pre-wrap">${data.response}</div>
      `;

      // Learning point
      if (learningPointData && learningPointData.dataset.content) {
        const lpBubble = document.createElement('div');
        lpBubble.className = 'msg-row msg-ai';
        lpBubble.innerHTML = `
          <div class="msg-avatar" style="background:#d1fae5;color:#059669;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">‚úì</div>
          <div class="msg-bubble" style="background:#f0fdf4;border:1px solid #bbf7d0;border-top-left-radius:4px;color:#065f46;max-width:80%;padding:12px 18px;border-radius:16px;font-size:14px;font-weight:500;line-height:1.65;">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#059669;margin-bottom:6px;">üí° ≈†to smo nauƒçili?</div>
            ${learningPointData.dataset.content}
          </div>
        `;
        chatContainer.appendChild(lpBubble);
      }

    } catch (error) {
      aiBubble.innerHTML = `
        <div class="msg-avatar" style="background:#fee2e2;color:#ef4444;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">!</div>
        <div class="msg-bubble" style="background:#fef2f2;border:1px solid #fecaca;border-top-left-radius:4px;color:#991b1b;max-width:80%;padding:12px 18px;border-radius:16px;font-size:14px;font-weight:500;">
          Gre≈°ka: ${(error.message || 'Sustav nedostupan.').replace(/</g,'&lt;')}
        </div>
      `;
    } finally {
      btn.disabled = false;
      btn.innerHTML = `<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>`;
      chatContainer.lastElementChild && chatContainer.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
  };
</script>
